<project name="kort-build" basedir="." default="build">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="lib/antlibs/ant-contrib-1.0b3.jar"/>
		</classpath>
	</taskdef>
    
    <property name="uml.dir" value="_DOCUMENTATION/03_Model" />
    <property name="php.dir" value="server" />


	<target name="build" depends="test,generate_css,generate_uml">
		<echo message="BUILD FINISHED!"/>
	</target>
	
	<target name="test">
		<echo message="Running tests"/>
		<exec executable="grunt" failonerror="true">
			<arg value="travis"/>
			<arg value="--verbose"/>
			<arg value="--force"/>
		</exec>
    </target>

	<target name="php_lint">
		<echo message="Linting PHP files"/>
        <foreach target="phpcs" param="file">
            <path>
                <fileset dir="${php.dir}" includes="**/*.php"/>
            </path>
        </foreach>
    </target>

    <target name="generate_uml">
        <echo message="Generating image from yUML" />
        <exec executable="yuml">
            <arg value="-i"/>
            <arg value="_DOCUMENTATION/03_Model/data_model.yuml"/>
            <arg value="-o" />
            <arg value="_DOCUMENTATION/03_Model/data_model.png"/>
        </exec>
    </target>

	<target name="generate_css">
		<echo message="Compile sass files to css"/>
		<foreach target="compile_sass" param="dir">
			<path>
				<dirset dir="${basedir}">
					<include name="**/styles"/>
				</dirset>
			</path>
		</foreach>
	</target>
	
	<target name="compile_sass">
		<echo message="Compile sass files in ${dir}"/>
		<apply executable="sass" dest="${dir}" verbose="true" force="true" failonerror="true">
			<arg value="--unix-newlines" />
			<srcfile />
			<targetfile />
			<fileset dir="${dir}" includes="**/*.scss" />
			<mapper type="glob" from="*.scss" to="*.css"/>
		</apply>
    </target>

    <target name="phpcs">
        <echo message="Linting PHP file ${file}"/>
        <exec executable="phpcs">
            <arg value="--standard=PSR2"/>
            <arg value="${file}"/>
        </exec>
    </target>
</project>
