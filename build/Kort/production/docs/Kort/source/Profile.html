<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Kort-controller-Profile'>/**
</span> * Controller for profile tab
 */
Ext.define('Kort.controller.Profile', {
    extend: 'Ext.app.Controller',
    requires: [
        'Ext.LoadMask'
    ],

    config: {
<span id='Kort-controller-Profile-cfg-views'>        views: [
</span>            'profile.Container',
            'profile.BadgesContainer'
        ],
<span id='Kort-controller-Profile-cfg-refs'>        refs: {
</span>            mainTabPanel: '#mainTabPanel',
            profileContainer: '#profileContainer',
            profileContentComponent: '.profilecontentcomponent',
            profileBadgesDataView: '.profilebadgesdataview',
            profileRefreshButton: '#profileContainer .button[cls=profileRefreshButton]',
            profileSettingsButton: '#profileContainer .button[cls=profileSettingsButton]',
            profileLogoutButton: '#profileContainer .button[cls=profileLogoutButton]',
            badgesContainerBackButton: '.badgescontainer .button[cls=badgesContainerBackButton]'
        },
<span id='Kort-controller-Profile-cfg-control'>        control: {
</span>            profileContentComponent: {
                initialize: 'onProfileContentComponentInitialize'
            },
            profileBadgesDataView: {
                itemtap: 'onProfileBadgesDataViewItemTap'
            },
            profileRefreshButton: {
                tap: 'onProfileRefreshButtonTap'
            },
            profileSettingsButton: {
                tap: 'onProfileSettingsButtonTap'
            },
            profileLogoutButton: {
                tap: 'onProfileLogoutButtonTap'
            },
            badgesContainerBackButton: {
                tap: 'onBadgesContainerBackButtonTap'
            }
        },

<span id='Kort-controller-Profile-cfg-badgesContainer'>        badgesContainer: null
</span>    },
    
<span id='Kort-controller-Profile-method-init'>    // @private
</span>    init: function() {
        var me = this;
        me.callParent(arguments);
        
        me.getApplication().on({
            votesend: { fn: me.refreshProfile, scope: me },
            fixsend: { fn: me.refreshProfile, scope: me }
        });
    },

<span id='Kort-controller-Profile-method-onProfileContentComponentInitialize'>    // @private
</span>    onProfileContentComponentInitialize: function() {
        if(!Kort.user) {
            Ext.defer(this.onProfileContentComponentInitialize, 500, this);
        } else {
            this.getProfileContentComponent().setRecord(Kort.user);
        }
    },

<span id='Kort-controller-Profile-method-onProfileBadgesDataViewItemTap'>    // @private
</span>    onProfileBadgesDataViewItemTap: function(dataViewCmp, index, target, record, e) {
        var badgesContainer = Ext.create('Kort.view.profile.BadgesContainer', {
            selectedBadgeIndex: index
        });
        this.setBadgesContainer(badgesContainer);
        Ext.Viewport.add(badgesContainer);
        badgesContainer.show();
    },

<span id='Kort-controller-Profile-method-onBadgesContainerBackButtonTap'>    // @private
</span>    onBadgesContainerBackButtonTap: function() {
        this.getBadgesContainer().hide();
    },

<span id='Kort-controller-Profile-method-onProfileLogoutButtonTap'>    // @private
</span>    onProfileLogoutButtonTap: function() {
        var me = this,
            userLocalStore = Ext.getStore('UserLocal');

        me.showLoadMask(Ext.i18n.Bundle.message('profile.logout.loadmask.message'));
        Ext.Ajax.request({
            url: Kort.util.Config.getWebservices().userLogout.getUrl(Kort.user.get('id')),
            success: function(response){
                userLocalStore.removeAll();
                
                // reload current page
                window.location.reload();
            }
        });
    },

<span id='Kort-controller-Profile-method-onProfileRefreshButtonTap'>    // @private
</span>    onProfileRefreshButtonTap: function() {
        this.refreshProfile();
    },
    
<span id='Kort-controller-Profile-method-onProfileSettingsButtonTap'>    // @private
</span>    onProfileSettingsButtonTap: function() {
        Ext.Msg.prompt(
            Ext.i18n.Bundle.message('profile.settings.messagebox.title'),
            Ext.i18n.Bundle.message('profile.settings.messagebox.message'),
            this.settingsSaveHandler,
            this,
            false,
            Kort.user.get('username'),
            {
                name: 'profileSettingsUsername'
            }
        );
    },
    
<span id='Kort-controller-Profile-method-settingsSaveHandler'>    /**
</span>     * @private
     * Called when settings prompt gets closed
     */
    settingsSaveHandler: function(buttonId, value) {
        var me = this,
            messageBox;

        if(buttonId === 'ok') {
            if(value !== '') {
                if(value.search(/^[a-zA-Z0-9]+$/) === -1) {
                    messageBox = Ext.create('Kort.view.NotificationMessageBox');
                    messageBox.alert(Ext.i18n.Bundle.message('profile.alert.username.specialchars.title'), Ext.i18n.Bundle.message('profile.alert.username.specialchars.message'), Ext.emptyFn);
                } else {
                    // if username is different
                    if(value !== Kort.user.get('username')) {
                        Kort.user.set('username', value);
                        me.showLoadMask(Ext.i18n.Bundle.message('profile.username.loadmask.message'));
                        Kort.user.save({
                            success: function() {
                                me.userSuccessfullSavedHandler();
                            },
                            failure: function() {
                                messageBox = Ext.create('Kort.view.NotificationMessageBox');
                                messageBox.alert(Ext.i18n.Bundle.message('profile.alert.submit.failure.title'), Ext.i18n.Bundle.message('profile.alert.submit.failure.message'), Ext.emptyFn);
                            }
                        }, me);
                    }
                }
            } else {
                messageBox = Ext.create('Kort.view.NotificationMessageBox');
                messageBox.alert(Ext.i18n.Bundle.message('profile.alert.username.empty.title'), Ext.i18n.Bundle.message('profile.alert.username.empty.message'), Ext.emptyFn);
            }
        }
    },
    
<span id='Kort-controller-Profile-method-userSuccessfullSavedHandler'>    /**
</span>     * @private
     * Called when user was successfull saved
     */
    userSuccessfullSavedHandler: function(store, operation) {
        this.getApplication().fireEvent('userchange');
        this.hideLoadMask();
    },
    
<span id='Kort-controller-Profile-method-refreshProfile'>    /**
</span>     * @private
     * Refreshes user
     */
    refreshProfile: function() {
        var me = this;
        
        // show loadmask only if container is already loaded
        if(this.getProfileContainer()) {
            me.showLoadMask(Ext.i18n.Bundle.message('profile.refresh.loadmask.message'));
        }
        
        Kort.model.User.reload(Kort.user, 'secret', me.hideLoadMask, me);
    },

<span id='Kort-controller-Profile-method-showLoadMask'>    // @private
</span>    showLoadMask: function(message) {
        this.getProfileRefreshButton().disable();
        this.getProfileContainer().setMasked({
            xtype: 'loadmask',
            message: message
        });

        Ext.defer(this.hideLoadMask, Kort.util.Config.getTimeout(), this);
    },

<span id='Kort-controller-Profile-method-hideLoadMask'>    // @private
</span>    hideLoadMask: function() {
        this.getProfileRefreshButton().enable();
        this.getProfileContainer().setMasked(false);
    }
});</pre>
</body>
</html>
