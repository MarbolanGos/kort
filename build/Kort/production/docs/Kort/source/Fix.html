<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Kort-controller-Fix'>/**
</span> * Controller for fix panel
 */
Ext.define('Kort.controller.Fix', {
    extend: 'Kort.controller.OsmMap',

    config: {
<span id='Kort-controller-Fix-event-fixsend'>        /**
</span>         * @event fixsend
         * Fired when fix was sent
         * @param {Ext.ux.LeafletMap} this
         * @param {L.Map} map The rendered L.Map instance
         * @param {L.TileLayer} tileLayer The rendered L.TileLayer instance
         */
        
        views: [
            'bugmap.NavigationView',
            'bugmap.fix.TabPanel',
            'bugmap.fix.Form',
            'LeafletMap',
            'RewardMessageBox'
        ],
<span id='Kort-controller-Fix-cfg-refs'>        refs: {
</span>            bugmapNavigationView: '#bugmapNavigationView',
            detailComponent: '.fixtabpanel',
            fixFormSubmitButton: '.fixtabpanel .formpanel .button[cls=fixSubmitButton]',
            fixField: '.fixtabpanel .formpanel .field',
            fixmap: '.fixtabpanel .kortleafletmap[cls=fixMap]'
        },
<span id='Kort-controller-Fix-cfg-control'>        control: {
</span>            fixFormSubmitButton: {
                tap: 'onFixFormSubmitButtonTap'
            },
            fixField: {
                keyup: 'onFixFieldKeyUp'
            },
            fixmap: {
                maprender: 'onMaprender'
            }
        }
    },
    
<span id='Kort-controller-Fix-method-onFixFormSubmitButtonTap'>    // @private
</span>    onFixFormSubmitButtonTap: function() {
        var me = this,
            detailComponent = this.getDetailComponent(),
            fixFieldValue = this.getFixField().getValue(),
            userId = Kort.user.get('id'),
            fix,
            messageBox;

        if (fixFieldValue &amp;&amp; fixFieldValue !== '') {
            me.showSendMask();
            fix = Ext.create('Kort.model.Fix', {
                error_id: detailComponent.getRecord().get('id'),
                schema: detailComponent.getRecord().get('schema'),
                osm_id: detailComponent.getRecord().get('osm_id'),
                user_id: userId,
                message: fixFieldValue
            });
            fix.save({
                success: function(records, operation) {
                    me.hideSendMask();
                    me.fixSuccessfulSubmittedHandler(operation.getResponse().responseText);
                },
                failure: function() {
                    me.hideSendMask();
                    var messageBox = Ext.create('Kort.view.NotificationMessageBox');
                    messageBox.alert(Ext.i18n.Bundle.message('fix.alert.submit.failure.title'), Ext.i18n.Bundle.message('fix.alert.submit.failure.message'), Ext.emptyFn);
                }
            });
        } else {
            messageBox = Ext.create('Kort.view.NotificationMessageBox');
            messageBox.alert(Ext.i18n.Bundle.message('fix.alert.fixfield.empty.title'), Ext.i18n.Bundle.message('fix.alert.fixfield.empty.message'), Ext.emptyFn);
        }
    },

<span id='Kort-controller-Fix-method-onFixFieldKeyUp'>    // @private
</span>    onFixFieldKeyUp: function(field, e) {
        // submit form if return key was pressed
        if (e.event.keyCode === 13){
            this.onFixFormSubmitButtonTap();
        }
    },

<span id='Kort-controller-Fix-method-fixSuccessfulSubmittedHandler'>    /**
</span>     * @private
     * Called when a fix was successfully submitted
     * @param {String} responseText Response from server
     */
    fixSuccessfulSubmittedHandler: function(responseText) {
        var rewardConfig = JSON.parse(responseText),
            reward = Ext.create('Kort.model.Reward', rewardConfig),
            bugmapNavigationView = this.getBugmapNavigationView();
        
        this.showRewardMessageBox(reward);
        // remove detail panel
        bugmapNavigationView.pop();
        bugmapNavigationView.fireEvent('back', bugmapNavigationView);
        this.getApplication().fireEvent('fixsend');
    },
    
<span id='Kort-controller-Fix-method-showSendMask'>    // @private
</span>    showSendMask: function() {
        this.getBugmapNavigationView().setMasked({
            xtype: 'loadmask',
            message: Ext.i18n.Bundle.message('fix.sendmask.message'),
            zIndex: Kort.util.Config.getZIndex().overlayLeafletMap
        });
    },
    
<span id='Kort-controller-Fix-method-hideSendMask'>    // @private
</span>    hideSendMask: function() {
        this.getBugmapNavigationView().setMasked(false);
    },
    
<span id='Kort-controller-Fix-method-showRewardMessageBox'>    /**
</span>     * @private
     * Shows message box with rewards
     * @param {Kort.model.Reward} reward Won reward
     */
	showRewardMessageBox: function(reward) {
        var messageBox = Ext.create('Kort.view.RewardMessageBox', {
            record: reward
        });
        messageBox.alert(Ext.i18n.Bundle.message('reward.alert.title'), messageBox.getRewardTpl().apply(reward.data), Ext.emptyFn);
	}
});</pre>
</body>
</html>
