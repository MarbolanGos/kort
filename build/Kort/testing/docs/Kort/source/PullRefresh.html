<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*jshint maxcomplexity:10 */
<span id='Kort-plugin-PullRefresh'>/**
</span> * Translated pull refresh plugin
 */
Ext.define('Kort.plugin.PullRefresh', {
    extend: 'Ext.plugin.PullRefresh',
    alias: 'plugin.kortpullrefresh',
	
	config: {
<span id='Kort-plugin-PullRefresh-cfg-pullRefreshText'>        pullRefreshText: Ext.i18n.Bundle.message('pullrefresh.pullrefresh'),
</span><span id='Kort-plugin-PullRefresh-cfg-loadingText'>        loadingText: Ext.i18n.Bundle.message('pullrefresh.loading'),
</span><span id='Kort-plugin-PullRefresh-cfg-releaseRefreshText'>        releaseRefreshText: Ext.i18n.Bundle.message('pullrefresh.releaserefresh'),
</span><span id='Kort-plugin-PullRefresh-cfg-lastUpdatedText'>        lastUpdatedText: Ext.i18n.Bundle.message('pullrefresh.lastupdated'),
</span><span id='Kort-plugin-PullRefresh-cfg-dateFormat'>        dateFormat: 'd.m.Y H:i:s',
</span><span id='Kort-plugin-PullRefresh-cfg-refreshFn'>        refreshFn: function(callbackFn, scope) {
</span>            var me = this,
                list = me.getList(),
                store = list.getStore();

            if (store) {
                store.load(function(records, operation, success) {
                    store.updateDistances(Kort.geolocation);
                    callbackFn.call(scope);
                    // wait until bounce back animation is done
                    Ext.defer(function() {
                        list.refresh();
                    }, 500);
                });
            } else {
                callbackFn.call(scope);
            }
        },
        
<span id='Kort-plugin-PullRefresh-cfg-pullTpl'>		pullTpl: [
</span>            '&lt;div class=&quot;x-list-pullrefresh&quot;&gt;',
                '&lt;div class=&quot;x-list-pullrefresh-arrow&quot;&gt;&lt;/div&gt;',
                '&lt;div class=&quot;x-loading-spinner&quot;&gt;',
                    '&lt;span class=&quot;x-loading-top&quot;&gt;&lt;/span&gt;',
                    '&lt;span class=&quot;x-loading-right&quot;&gt;&lt;/span&gt;',
                    '&lt;span class=&quot;x-loading-bottom&quot;&gt;&lt;/span&gt;',
                    '&lt;span class=&quot;x-loading-left&quot;&gt;&lt;/span&gt;',
                '&lt;/div&gt;',
                '&lt;div class=&quot;x-list-pullrefresh-wrap&quot;&gt;',
                    '&lt;h3 class=&quot;x-list-pullrefresh-message&quot;&gt;{message}&lt;/h3&gt;',
                    '&lt;div class=&quot;x-list-pullrefresh-updated&quot;&gt;{lastUpdatedText}&amp;nbsp;{lastUpdatedFormatted}&lt;/div&gt;',
                '&lt;/div&gt;',
            '&lt;/div&gt;'
        ].join('')
	},
    
<span id='Kort-plugin-PullRefresh-method-initScrollable'>    // @inheritdoc
</span>    initScrollable: function() {
        var me = this,
            list = me.getList(),
            store = list.getStore(),
            pullTpl = me.getPullTpl(),
            element = me.element,
            scrollable = list.getScrollable(),
            scroller;

        if (!scrollable) {
            return;
        }

        scroller = scrollable.getScroller();

        me.lastUpdated = new Date();
        me.lastUpdatedFormatted = Ext.util.Format.date(me.lastUpdated, me.getDateFormat());

        list.container.insert(0, me);

        // We provide our own load mask so if the Store is autoLoading already disable the List's mask straight away,
        // otherwise if the Store loads later allow the mask to show once then remove it thereafter
        if (store) {
            if (store.isAutoLoading()) {
                list.setLoadingText(null);
            } else {
                store.on({
                    load: {
                        single: true,
                        fn: function() {
                            list.setLoadingText(null);
                        }
                    }
                });
            }
        }

        pullTpl.overwrite(element, {
            message: me.getPullRefreshText(),
            lastUpdatedText: me.getLastUpdatedText(),
            lastUpdatedFormatted: me.lastUpdatedFormatted
        }, true);

        me.loadingElement = element.getFirstChild();
        me.messageEl = element.down('.x-list-pullrefresh-message');
        me.updatedEl = element.down('.x-list-pullrefresh-updated');

        me.maxScroller = scroller.getMaxPosition();

        scroller.on({
            maxpositionchange: me.setMaxScroller,
            scroll: me.onScrollChange,
            scope: me
        });
    },
    
<span id='Kort-plugin-PullRefresh-method-loadStore'>    /**
</span>     * @inheritdoc
	 * OVERRIDEN SENCHA TOUCH FUNCTION
	 * CHANGE: wait for a longer time to scroll to top
	 */
    loadStore: function() {
        var me = this,
            list = me.getList(),
            scroller = list.getScrollable().getScroller();

        me.setViewState('loading');
        me.isReleased = false;

        Ext.defer(function() {
            scroller.on({
                scrollend: function() {
                    if (me.getRefreshFn()) {
                        me.getRefreshFn().call(me, me);
                    } else {
                        me.fetchLatest();
                    }
                    me.resetRefreshState();
                },
                delay: 100,
                single: true,
                scope: me
            });
            scroller.minPosition.y = 0;
            scroller.scrollTo(null, 0, true);
		// CHANGE: wait for a longer time to scroll to top
        }, 1000, me);
    },
    
<span id='Kort-plugin-PullRefresh-method-resetRefreshState'>    /**
</span>     * @inheritdoc
	 * OVERRIDEN SENCHA TOUCH FUNCTION
	 * CHANGE: German date format
	 */
    resetRefreshState: function() {
        var me = this;

        me.isRefreshing = false;
        me.lastUpdated = new Date();
        me.lastUpdatedFormatted = Ext.util.Format.date(me.lastUpdated, me.getDateFormat());

        me.setViewState('pull');
        me.updatedEl.setHtml(this.getLastUpdatedText() + '&amp;nbsp;' +  me.lastUpdatedFormatted);
    }
});</pre>
</body>
</html>
