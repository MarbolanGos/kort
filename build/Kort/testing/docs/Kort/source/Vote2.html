<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Kort-controller-Vote'>/**
</span> * Controller for vote panel
 */
Ext.define('Kort.controller.Vote', {
    extend: 'Kort.controller.OsmMap',

    config: {
<span id='Kort-controller-Vote-cfg-views'>        views: [
</span>            'validation.NavigationView',
            'validation.vote.Container',
            'validation.vote.AnswerActionSheet',
            'LeafletMap'
        ],
<span id='Kort-controller-Vote-cfg-refs'>        refs: {
</span>            validationNavigationView: '#validationNavigationView',
            detailComponent: '.votecontainer',
            voteMap: '.votecontainer .kortleafletmap[cls=voteMap]',
            voteAnswerButton: '.votecontainer .button[cls=voteAnswerButton]',
            voteAnswerConfirmButton: '.voteansweractionsheet .button[cls=voteAnswerConfirmButton]',
            voteAnswerDeclineButton: '.voteansweractionsheet .button[cls=voteAnswerDeclineButton]',
            voteAnswerCancelButton: '.voteansweractionsheet .button[cls=voteAnswerCancelButton]'
        },
<span id='Kort-controller-Vote-cfg-control'>        control: {
</span>            voteMap: {
                maprender: 'onMaprender'
            },
            voteAnswerButton: {
                tap: 'onVoteAnswerButtonTap'
            },
            voteAnswerConfirmButton: {
                tap: 'onVoteAnswerConfirmButtonTap'
            },
            voteAnswerDeclineButton: {
                tap: 'onVoteAnswerDeclineButtonTap'
            },
            voteAnswerCancelButton: {
                tap: 'onVoteAnswerCancelButtonTap'
            }
        },
        
<span id='Kort-controller-Vote-cfg-answerActionSheet'>        answerActionSheet: null
</span>    },
    
<span id='Kort-controller-Vote-method-onVoteAnswerButtonTap'>    // @private
</span>    onVoteAnswerButtonTap: function() {
        var answerActionSheet = Ext.create('Kort.view.validation.vote.AnswerActionSheet');
        
        this.setAnswerActionSheet(answerActionSheet);
        Ext.Viewport.add(answerActionSheet);
        answerActionSheet.show();
    },
    
<span id='Kort-controller-Vote-method-onVoteAnswerConfirmButtonTap'>    // @private
</span>    onVoteAnswerConfirmButtonTap: function() {
        if(this.getAnswerActionSheet()) {
            this.getAnswerActionSheet().hide();
        }
        this.sendVote(true);
    },
    
<span id='Kort-controller-Vote-method-onVoteAnswerDeclineButtonTap'>    // @private
</span>    onVoteAnswerDeclineButtonTap: function() {
        if(this.getAnswerActionSheet()) {
            this.getAnswerActionSheet().hide();
        }
        this.sendVote(false);
    },
    
<span id='Kort-controller-Vote-method-onVoteAnswerCancelButtonTap'>    // @private
</span>    onVoteAnswerCancelButtonTap: function() {
        if(this.getAnswerActionSheet()) {
            this.getAnswerActionSheet().hide();
        }
        // remove detail panel
        this.getValidationNavigationView().pop();
    },
    
<span id='Kort-controller-Vote-method-sendVote'>    /**
</span>     * @private
     * Sends vote to server
     * @param {Boolean} valid Validation is correct (true) or wron (false)
     */
    sendVote: function(valid) {
        var me = this,
            detailComponent = me.getDetailComponent(),
            userId = Kort.user.get('id'),
            vote,
            validString;
        
        // for valid post request valid field has to be a string
        validString = valid.toString();
        
        me.showSendMask();
        vote = Ext.create('Kort.model.Vote', { fix_id: detailComponent.getRecord().get('id'), user_id: userId, valid: validString });
        vote.save({
            success: function(records, operation) {
                me.hideSendMask();
                me.voteSuccessfulSubmittedHandler(operation.getResponse().responseText);
            },
            failure: function() {
                me.hideSendMask();
                var messageBox = Ext.create('Kort.view.NotificationMessageBox');
                messageBox.alert(Ext.i18n.Bundle.message('vote.alert.submit.failure.title'), Ext.i18n.Bundle.message('vote.alert.submit.failure.message'), Ext.emptyFn);
            }
        });
    },
    
<span id='Kort-controller-Vote-method-voteSuccessfulSubmittedHandler'>    /**
</span>     * @private
     * Called when vote was successfully submitted to server
     * @param {String} responseText Response from server
     */
    voteSuccessfulSubmittedHandler: function(responseText) {
        var rewardConfig = Ext.decode(responseText),
            reward = Ext.create('Kort.model.Reward', rewardConfig);
        
        this.getApplication().fireEvent('votesend');
        
        this.showRewardMessageBox(reward);
        // remove detail panel
        this.getValidationNavigationView().pop();
    },
    
<span id='Kort-controller-Vote-method-showSendMask'>    // @private
</span>    showSendMask: function() {
        this.getValidationNavigationView().setMasked({
            xtype: 'loadmask',
            message: Ext.i18n.Bundle.message('vote.sendmask.message'),
            zIndex: Kort.util.Config.getZIndex().overlayLeafletMap
        });
    },
    
<span id='Kort-controller-Vote-method-hideSendMask'>    // @private
</span>    hideSendMask: function() {
        this.getValidationNavigationView().setMasked(false);
    },
    
<span id='Kort-controller-Vote-method-showRewardMessageBox'>    /**
</span>     * @private
     * Shows reward message box
     * @param {Kort.model.Reward} reward Reward instance
     */
	showRewardMessageBox: function(reward) {
        var messageBox = Ext.create('Kort.view.RewardMessageBox', {
            record: reward
        });
        messageBox.alert(Ext.i18n.Bundle.message('reward.alert.title'), messageBox.getRewardTpl().apply(reward.data), Ext.emptyFn);
	}
});</pre>
</body>
</html>
